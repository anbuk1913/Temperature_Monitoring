<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Imbed Software</title>
        <link rel="icon" href="/images/logo.png">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
        <style>
            body { background: #f5f6fa; }
            .dashboard { max-width: 1000px; margin: 20px auto; }
            .card { border-radius: 15px; padding: 20px; color: white; }
            .temp-card.green { background: #28a745; }
            .temp-card.yellow { background: #ffc107; color: #212529; }
            .temp-card.red { background: #dc3545; }
            .humidity-card.low { background: #007bff; }
            .humidity-card.normal { background: #20c997; }
            .humidity-card.high { background: #6610f2; }
        </style>
    </head>
    <body>
    <div class="container dashboard">
        <h1 class="text-center mb-4"><a href=""><i><img src="/images/logo.png" alt="" width="50px" style="margin-bottom: 20px;"></i></a>Imbed Software</h1>
        <div class="row g-4">
            <div class="col-md-6">
                <div id="tempCard" class="card temp-card">
                    <h3><i class="fas fa-temperature-high"></i> Temperature</h3>
                    <p class="display-5" id="tempC"><%= temperature.toFixed(1) %>°C</p>
                </div>
            </div>
            <div class="col-md-6">
                <div id="humidityCard" class="card humidity-card">
                    <h3><i class="fas fa-tint"></i> Humidity</h3>
                    <p class="display-5" id="humidity"><%= humidity.toFixed(1) %>%</p>
                </div>
            </div>
        </div>
        <% if (historicaldata && historicaldata.length > 0) { %>
        <div class="mt-5">
            <h4><i class="fas fa-chart-line"></i> Historical Trends</h4>
            <canvas id="trendChart" height="100"></canvas>
        </div>
        <% } %>
    </div>
    <div hidden>
        <button id="temp" data-temperature="<%= temperature %>"></button>
        <button id="hum" data-humidity="<%= humidity %>"></button>
        <div id="historical-data"
            data-historical='<%- JSON.stringify(historicaldata) %>'>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function updateTempColor(tempC){
            const tempCard = document.getElementById('tempCard');
            tempCard.classList.remove('green', 'yellow', 'red');
            if (tempC >= 20 && tempC <= 25) tempCard.classList.add('green');
            else if ((tempC >= 15 && tempC < 20) || (tempC > 25 && tempC <= 30)) tempCard.classList.add('yellow');
            else tempCard.classList.add('red');
        }

        function updateHumidityColor(hum){
            const humidityCard = document.getElementById('humidityCard');
            humidityCard.classList.remove('low', 'normal', 'high');
            if (hum < 30) humidityCard.classList.add('low');
            else if (hum >= 30 && hum <= 60) humidityCard.classList.add('normal');
            else humidityCard.classList.add('high');
        }

        const btn1 = document.getElementById("temp");
        const btn2 = document.getElementById("hum");
        const element = document.getElementById('historical-data');

        updateTempColor(Number(btn1.dataset.temperature));
        updateHumidityColor(Number(btn2.dataset.humidity));

        const data = JSON.parse(element.dataset.historical);

        if (data && data.length > 0){
            const ctx = document.getElementById('trendChart').getContext('2d');
            const trendChart = new Chart(ctx,{
                type: 'line',
                data: {
                    labels: data.map(d => d.time),
                    datasets: [
                        {
                            label: 'Temperature (°C)',
                            data: data.map(d => d.temperatureC),
                            borderColor: '#dc3545',
                            fill: false
                        },
                        {
                            label: 'Humidity (%)',
                            data: data.map(d => d.humidity),
                            borderColor: '#007bff',
                            fill: false
                        }
                    ]
                },
                options: { responsive: true }
            });
        }
    </script>
    </body>
</html>